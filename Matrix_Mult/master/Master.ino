//altSoftSerial pins: TX:9, RX:8
//i2c pins: SDA:A4, SCL:A5

#include <Wire.h>
#include <AltSoftSerial.h>
#include <I2C_Anything.h>
#define i2c_MASTER_ADDRESS 8
#define i2c_ADDRESS_MIN 9
#define i2c_ADDRESS_MAX 119
#define i2c_PROPAGATION_DELAY 10 //micro seconds
#define HW_SERIAL_BAUD 115200
#define SW_SERIAL_BAUD 31250
#define i2c_CLOCK 400000L
#define N 8 //matrix dimension(s)
#define X 1 //columns per device
uint8_t datatype_size = BUFFER_LENGTH / sizeof(float); //bytes


AltSoftSerial altSerial;
bool done_transmitting_a = false;
bool done_receiving_c = false;


unsigned long startTime;
unsigned long endTime;
unsigned long receivedTime;
unsigned long CPU_time = 0;


uint8_t countDevices();
void assignAddresses();
float rando();
void receiveC(uint8_t howMany);
void sendData();
void Signal();
void printMatrix();


uint8_t iter_x = 0, iter_y = 0;
float C[N][N];
/*const PROGMEM float C[16][16] = {
  {225667857519267236626117995000000000000.0000000,  216550428733046158878570363000000000000.0000000,  22140156412031764454612946000000000000.0000000, 305378380464241824950570694000000000000.0000000,  176064744772138270324770414000000000000.0000000,  305995285461330484868356425000000000000.0000000,  265861651166714387421792090000000000000.0000000,  -214541353912418546444221239000000000000.0000000, 95732783704485976765719519000000000000.0000000, -167831517804112185355533789000000000000.0000000, 231181469679014682432659757000000000000.0000000,  326011897706904184676615460000000000000.0000000,  113499641933170741850414121000000000000.0000000,  -267275888593169709390096015000000000000.0000000, -239679357357241732022339787000000000000.0000000, -269029069948534373104035798000000000000.0000000},
  {-48120146057650253661644796000000000000.0000000, -314444071052426553168599046000000000000.0000000, 95536428521613318875722779000000000000.0000000, -12504885503698336399409493000000000000.0000000,  -3531231376804274730805107000000000000.0000000, 42450984094911948174096108000000000000.0000000, 267457240392639343386297003000000000000.0000000,  139636136749975908515467551000000000000.0000000,  193573677404184525339357123000000000000.0000000,  99084212557721416223331597000000000000.0000000, 203466259027160877451637052000000000000.0000000,  180737006035435621213959837000000000000.0000000,  221600859896121371988220125000000000000.0000000,  315087066417423516934065849000000000000.0000000,  166772932433575786295353683000000000000.0000000,  -232478745158867319832925439000000000000.0000000},
  {115100671892007490796188359000000000000.0000000, 31997665077864520732139484000000000000.0000000, 313967171660064040430514135000000000000.0000000,  -111691237117899724409456541000000000000.0000000, 109021419070350406375384620000000000000.0000000,  -163609141677625332810586647000000000000.0000000, -46695584675307055127494473000000000000.0000000,  -136788720084841642268094342000000000000.0000000, 63811832050580048537117229000000000000.0000000, -167686042893366396312455085000000000000.0000000, -18812713376403777314359008000000000000.0000000,  262537795488281747563184949000000000000.0000000,  270127098361209835877426901000000000000.0000000,  81796745878893214020623016000000000000.0000000, -142928532821587737303099522000000000000.0000000, -122427857848585667231719458000000000000.0000000},
  {-22119123252300863767502184000000000000.0000000, 209930710700323528348754034000000000000.0000000,  -111006344010087481467739617000000000000.0000000, -166900315389820313398519014000000000000.0000000, -174921634801898138694769155000000000000.0000000, 181545468450952973267557872000000000000.0000000,  322375816375685764571023200000000000000.0000000,  154982097450100400105436030000000000000.0000000,  -165758507357919242177701737000000000000.0000000, -139330696943861954429833242000000000000.0000000, 168878721412063372823179461000000000000.0000000,  223256839817734256559590073000000000000.0000000,  -273454443939020650604996562000000000000.0000000, 13205601962514534326736807000000000000.0000000, -218764000346586312946332951000000000000.0000000, -142112896231884493259095560000000000000.0000000},
  {-319180193933931076473344223000000000000.0000000,  286888564428742037780667603000000000000.0000000,  -215693066304040298747229999000000000000.0000000, -283962054369894536465451981000000000000.0000000, 261057704080618681137535410000000000000.0000000,  124315895097525167189715618000000000000.0000000,  112672473801939054676434753000000000000.0000000,  283456307550079641756570516000000000000.0000000,  -86202351265601287274726178000000000000.0000000,  -317612764352307016766060019000000000000.0000000, 78588114897383259962846247000000000000.0000000, -2661081604919728812088884000000000000.0000000, -65781038655963830436762735000000000000.0000000,  -104669432845457511440790045000000000000.0000000, 31841270789684813783449011000000000000.0000000, 194467936887345480058098288000000000000.0000000},
  {84373770176255823113413206000000000000.0000000,  -147300065702843019736429917000000000000.0000000, -153792434311076863138452345000000000000.0000000, 210679303830145408303305381000000000000.0000000,  33875825367650921126340021000000000000.0000000, -309930289484547502884817179000000000000.0000000, -149565794314960645726357647000000000000.0000000, -48840431558239382747130405000000000000.0000000,  -221886658693767070861250076000000000000.0000000, 39909133149420741580849122000000000000.0000000, -64187402473412425786685400000000000000.0000000,  230722267615612157249582022000000000000.0000000,  -214276012919906643036495873000000000000.0000000, -151797348345252853155828132000000000000.0000000, -326005696936558083917473110000000000000.0000000, 225578307610410727950252720000000000000.0000000},
  {-24046710800061304250107344000000000000.0000000, 315444145892068133914809168000000000000.0000000,  -201235004538603689399661774000000000000.0000000, -171304365717318561913745064000000000000.0000000, 329469117404428973818348704000000000000.0000000,  -221645285942364199606695876000000000000.0000000, 243169534346357906713670004000000000000.0000000,  208219748338855827519058278000000000000.0000000,  108930050562870316896788394000000000000.0000000,  -163935705019175639235324801000000000000.0000000, -85852819269117906412294836000000000000.0000000,  -151903355429871568908185139000000000000.0000000, -301770934626543426808687818000000000000.0000000, 335360750364932952804120810000000000000.0000000,  248158261347590211311515194000000000000.0000000,  -225430356389673965212203705000000000000.0000000},
  {23700389160959142601103838000000000000.0000000,  -83337208139069514238639149000000000000.0000000,  73587654406697934201692373000000000000.0000000, -62136788709378793133026485000000000000.0000000,  183039733749187379392212123000000000000.0000000,  36396059621056499711995812000000000000.0000000, -250881175910910808905001884000000000000.0000000, 23732078775434475816253734000000000000.0000000, 318382338096060159033140553000000000000.0000000,  266737253198299515025184682000000000000.0000000,  -173149313729768094584775357000000000000.0000000, -18380407645556943641807598000000000000.0000000,  275955040650924771679052055000000000000.0000000,  -247245788057486232157141482000000000000.0000000, -93691427875769711994813864000000000000.0000000,  -81229153918359371587964523000000000000.0000000},
  {-221638368203566862350978755000000000000.0000000,  128007258588499574020821345000000000000.0000000,  53801224940303304349857408000000000000.0000000, -235165626468715549678095141000000000000.0000000, -23677433553352824456307047000000000000.0000000,  -319426568680269554808030801000000000000.0000000, -318438543997238269775966883000000000000.0000000, -213046604091716272437388068000000000000.0000000, 336420883575222502163329431000000000000.0000000,  123925454686724480288453214000000000000.0000000,  63791983651887529247578347000000000000.0000000, 127459230772928696994468456000000000000.0000000,  135892721906000038539856719000000000000.0000000,  301962141799951089206698011000000000000.0000000,  329020538835233141768701863000000000000.0000000,  250925673208263490720425339000000000000.0000000},
  {76022379043499780311972536000000000000.0000000,  232524663480189931269971466000000000000.0000000,  -8462585369532393101134980000000000000.0000000, 110479875266914066630055034000000000000.0000000,  76385512477648149818076450000000000000.0000000, -145437569594222423013399006000000000000.0000000, 1713431205130988889662922000000000000.0000000,  249644727016790190879758418000000000000.0000000,  -339326932518806528775171438000000000000.0000000, 176746141314665149955875353000000000000.0000000,  -207496773256844302425021645000000000000.0000000, -137366978753596191022836414000000000000.0000000, -183354015410545574166680367000000000000.0000000, -309961857826605782652798528000000000000.0000000, 47086632904315976232611679000000000000.0000000, 206809120838321573741268228000000000000.0000000},
  {91263125700700478458233543000000000000.0000000,  163181654771394202585191261000000000000.0000000,  -331623406042165611717061068000000000000.0000000, -260918001231696030970889514000000000000.0000000, -231706661881576149103469382000000000000.0000000, -294660107867409276952468827000000000000.0000000, 151461841469254361338588047000000000000.0000000,  -64635440913835879180820445000000000000.0000000,  338985389399255076727635057000000000000.0000000,  107502455294627843180280546000000000000.0000000,  129278835856188423947099160000000000000.0000000,  267782972669212220586614160000000000000.0000000,  128608595298542636827692912000000000000.0000000,  173650025948503211462847420000000000000.0000000,  79396287114074034696514722000000000000.0000000, 248265530900780663452517424000000000000.0000000},
  {-68348046539544824551788180000000000000.0000000, -124328152858581773810678799000000000000.0000000, 239713764792798111973552944000000000000.0000000,  -236269128892513304202097275000000000000.0000000, -112277047665229331900150421000000000000.0000000, 177239034506561218362695016000000000000.0000000,  49906642159548748672371576000000000000.0000000, 307663210061190780393713625000000000000.0000000,  -258247208031851629070501526000000000000.0000000, 329684264471488567634806968000000000000.0000000,  -258752425008021725263935069000000000000.0000000, -278485403507267268740302881000000000000.0000000, -161968293852261473635672005000000000000.0000000, -1620457087501503858483945000000000000.0000000, 16482882255967151086434048000000000000.0000000, -320709094203331494094601448000000000000.0000000},
  {99288150319967602720660839000000000000.0000000,  14836634989459412786626347000000000000.0000000, 228448929046697400682732617000000000000.0000000,  155206048908527492591364435000000000000.0000000,  10913523741811783455074739000000000000.0000000, 338888615900416393701783177000000000000.0000000,  89702231578325830641046743000000000000.0000000, 284186923078541934498680007000000000000.0000000,  299590087053692954890112076000000000000.0000000,  -212208860315497591872225297000000000000.0000000, 330120532907198356952714292000000000000.0000000,  -73510028328362254252955964000000000000.0000000,  27020600362677274843873428000000000000.0000000, -162138197567433697384807611000000000000.0000000, 73870410503125543731403608000000000000.0000000, -32072284802480571655658712000000000000.0000000},
  {-68724312714737422185743064000000000000.0000000, 754448670217469229839613000000000000.0000000, -65519060359852128564416439000000000000.0000000,  185543676459816318449807607000000000000.0000000,  -299745610779188513550481695000000000000.0000000, 157777439798179659169623276000000000000.0000000,  320330537251012432786494780000000000000.0000000,  338304475250769159735619212000000000000.0000000,  83245354516420618407525882000000000000.0000000, 271877754471762817377825327000000000000.0000000,  39866607695905478197740954000000000000.0000000, -165854291456572919764582041000000000000.0000000, 87041083006828977360403698000000000000.0000000, 302148941004526465700723403000000000000.0000000,  22968675195217394020475139000000000000.0000000, 59352898504385853467867745000000000000.0000000},
  {-191271300859222932438752490000000000000.0000000,  216878378801892213012882777000000000000.0000000,  91954186779455538497713431000000000000.0000000, 102995390484990644017180410000000000000.0000000,  -310734445589065505411915562000000000000.0000000, -183375201418744115329113411000000000000.0000000, 262642152642535861976664207000000000000.0000000,  330136992091778926862722239000000000000.0000000,  53653734808727955149972430000000000000.0000000, 258445658276875617815721168000000000000.0000000,  -12046220870747518735724961000000000000.0000000,  -174268464472658848814778033000000000000.0000000, 499951993133257691427396000000000000.0000000, 6450576098823820080180342000000000000.0000000,  93227254497089232554501388000000000000.0000000, 39451281843928361886192474000000000000.0000000},
  {-308450563585463245259680200000000000000.0000000,  168279175485633883397128416000000000000.0000000,  -138329831184370154314973514000000000000.0000000, -312783991041745193972915583000000000000.0000000, 114705011828846738407307607000000000000.0000000,  -178661341215467988828055209000000000000.0000000, -67107005705106423229977297000000000000.0000000,  231522069306751133575750038000000000000.0000000,  278138374739845390468905750000000000000.0000000,  306977213982023586147143700000000000000.0000000,  184086840241599566587618005000000000000.0000000,  -138020666717050341060373524000000000000.0000000, 308530234763609841129086982000000000000.0000000,  331422127493837273074145997000000000000.0000000,  142701399829230788457533538000000000000.0000000,  315774718500528071932809942000000000000.0000000}
  };*/

void setup() {
  delay(3000);
  //initialize communication links
  Serial.begin(HW_SERIAL_BAUD);
  altSerial.begin(SW_SERIAL_BAUD);
  Wire.setClock(i2c_CLOCK);
  Wire.begin(i2c_MASTER_ADDRESS);

  //initialize devices
  assignAddresses();
  delay(i2c_ADDRESS_MAX);
  //number of slaves should equal matrix dimension(s) * columns per device, N should be even for most optimal package transfer
  if (countDevices() == (N / X) && N % 2 == 0) {
    //  if (countDevices() == 3) { //DEBUG ONLY
    Serial.println("Devices initiated!\n");
    Wire.onReceive(receiveC);
    sendData();
    Signal();
  }
}

void loop() {
  if (done_receiving_c) {
    done_receiving_c = false;
    printMatrix();
    getCPUtime();
    Serial.print(F("Total time: "));
    Serial.println(endTime - startTime);
    Serial.print(F("CPU time: "));
    Serial.println(CPU_time);
  }
}

/*int freeRam () { //should return free DRAM
  extern int __heap_start, *__brkval;
  int v;
  return (int) &v - (__brkval == 0 ? (int) &__heap_start : (int) __brkval);
  }*/
